name: Create .github-workflows Repository

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Create Repository via GitHub API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create the repository
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/orgs/nathlan/repos \
            -d '{
              "name": ".github-workflows",
              "description": "Centralized reusable GitHub Actions workflows for Azure Landing Zone deployments",
              "private": false,
              "auto_init": true
            }'

          echo "Repository created successfully!"

      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Clone new repo and add files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Clone the newly created repo
          git clone https://x-access-token:$GH_TOKEN@github.com/nathlan/.github-workflows.git /tmp/target-repo
          cd /tmp/target-repo

          # Create directory structure
          mkdir -p .github/workflows

          # Copy the reusable workflow
          cp $GITHUB_WORKSPACE/.github/workflows/azure-terraform-deploy-reusable.yml .github/workflows/azure-terraform-deploy.yml

          # Create README
          echo "# Reusable GitHub Actions Workflows" > README.md
          echo "" >> README.md
          echo "Centralized repository for reusable GitHub Actions workflows for Azure Landing Zone deployments." >> README.md
          echo "" >> README.md
          echo "## Azure Terraform Deploy Workflow" >> README.md
          echo "" >> README.md
          echo "Path: \`.github/workflows/azure-terraform-deploy.yml\`" >> README.md
          echo "" >> README.md
          echo "### Usage" >> README.md
          echo "" >> README.md
          echo "Call this reusable workflow from your repository's workflow file:" >> README.md
          echo "" >> README.md
          echo "\`\`\`yaml" >> README.md
          echo "jobs:" >> README.md
          echo "  deploy:" >> README.md
          echo "    uses: nathlan/.github-workflows/.github/workflows/azure-terraform-deploy.yml@main" >> README.md
          echo "    with:" >> README.md
          echo "      environment: production" >> README.md
          echo "      terraform-version: '1.9.0'" >> README.md
          echo "      working-directory: terraform" >> README.md
          echo "      azure-region: uksouth" >> README.md
          echo "    secrets:" >> README.md
          echo "      AZURE_CLIENT_ID: \${{ secrets.AZURE_CLIENT_ID }}" >> README.md
          echo "      AZURE_TENANT_ID: \${{ secrets.AZURE_TENANT_ID }}" >> README.md
          echo "      AZURE_SUBSCRIPTION_ID: \${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> README.md
          echo "\`\`\`" >> README.md
          echo "" >> README.md
          echo "See the workflow file for complete documentation." >> README.md

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push
          git add .
          git commit -m "Add Azure Terraform reusable workflow"
          git push origin main

          echo "Files pushed successfully!"
