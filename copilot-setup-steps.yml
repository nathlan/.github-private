# Copilot Setup Steps
# This file defines the environment setup steps for Copilot agents
# These steps will be executed to prepare the environment with necessary tools
# Using GitHub Marketplace Actions for reliable, maintained installations

version: 1.0

setup_steps:
  # Install Terraform using HashiCorp's official action
  - name: Setup Terraform
    description: Install Terraform CLI using HashiCorp's official setup action
    type: action
    action: hashicorp/setup-terraform@v3
    with:
      terraform_version: latest
      terraform_wrapper: false
    verify:
      command: terraform version
      expected_output_contains: "Terraform v"

  # Install TFLint using the official marketplace action
  - name: Setup TFLint
    description: Install TFLint for Terraform linting and validation
    type: action
    action: terraform-linters/setup-tflint@v4
    with:
      tflint_version: latest
    post_install:
      - |
        # Verify installation
        tflint --version
    verify:
      command: tflint --version
      expected_output_contains: "TFLint version"

  # Install Checkov using the marketplace action
  - name: Setup Checkov
    description: Install Checkov for static code analysis and security scanning
    type: bash
    commands:
      - |
        # Install Checkov using pip3 (Checkov GitHub Action is for scanning, not setup)
        pip3 install --upgrade pip
        pip3 install checkov
        
        # Verify installation
        checkov --version
    verify:
      command: checkov --version
      expected_output_contains: "checkov version"
    notes:
      - "Using pip3 installation as bridgecrewio/checkov-action is designed for scanning, not setup"
      - "For CI/CD workflows, use: uses: bridgecrewio/checkov-action@v12"

  # Setup Terraform environment
  - name: Setup Terraform Environment
    description: Configure Terraform environment variables and plugins
    type: bash
    commands:
      - |
        # Create Terraform plugin directory
        mkdir -p ~/.terraform.d/plugins
        
        # Set environment variables
        echo "export TF_PLUGIN_CACHE_DIR=~/.terraform.d/plugin-cache" >> ~/.bashrc
        echo "export TF_IN_AUTOMATION=true" >> ~/.bashrc
        
        # Create plugin cache directory
        mkdir -p ~/.terraform.d/plugin-cache
        
        echo "Terraform environment setup complete"
    verify:
      command: test -d ~/.terraform.d/plugin-cache && echo "success"
      expected_output_contains: "success"

notes:
  - "These setup steps prepare the environment for Terraform module development and validation"
  - "Using GitHub Marketplace Actions for Terraform and TFLint ensures maintained, reliable installations"
  - "hashicorp/setup-terraform@v3: Official HashiCorp action for Terraform CLI installation"
  - "terraform-linters/setup-tflint@v4: Official TFLint action for linting setup"
  - "Checkov uses pip3 as the GitHub Action is designed for scanning workflows, not environment setup"
  - "The environment is optimized for CI/CD automation with TF_IN_AUTOMATION flag"
