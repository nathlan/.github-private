# Generated Terraform Modules Tracking

This file tracks all Terraform modules that have been generated by the AVM Terraform Module Creator agent.

## Module Registry

| Module Name | Organization | Repository URL | Status | Date Created |
|-------------|--------------|----------------|--------|--------------|
| terraform-azurerm-resource-group | nathlan | https://github.com/nathlan/terraform-azurerm-resource-group | âœ… Active | 2026-02-05 |
| terraform-azurerm-storage-account | nathlan | https://github.com/nathlan/terraform-azurerm-storage-account | âœ… Active | 2026-02-05 |
| terraform-azurerm-landing-zone-vending | nathlan | https://github.com/nathlan/terraform-azurerm-landing-zone-vending | âœ… Active | 2026-02-05 |
| terraform-azurerm-firewall | nathlan | https://github.com/nathlan/terraform-azurerm-firewall | âœ… Active | 2026-02-05 |
| terraform-azurerm-firewall-policy | nathlan | https://github.com/nathlan/terraform-azurerm-firewall-policy | ðŸš§ In Progress | 2026-02-05 |

## Module Details

### terraform-azurerm-resource-group
- **Purpose**: Azure Resource Group module (recreated version with validated agent workflow)
- **Type**: Simple resource module
- **Submodules**: None
- **AVM Consumed**: `Azure/avm-res-resources-resourcegroup/azurerm` version `~> 0.2.2`
- **Latest Release**: v1.0.0 (pending merge)
- **Features**:
  - Resource group creation with comprehensive input validation
  - Location validation restricting to australiaeast or australiacentral
  - Support for resource locks (CanNotDelete, ReadOnly)
  - Support for role assignments with conditions
  - Telemetry control
  - Automated release workflow for semantic versioning
  - Complete terraform-docs generated documentation

### terraform-azurerm-storage-account
- **Purpose**: Azure Storage Account with support for all storage types
- **Type**: Parent-child module structure
- **Submodules**:
  - `modules/blob` - Opinionated blob storage with secure defaults and region restrictions
- **Features**:
  - Generic parent storage account module supporting blob, file, queue, and table storage
  - Blob submodule with secure defaults (private access, TLS 1.2, versioning, soft delete)
  - Location validation locked to australiaeast or australiasoutheast

### terraform-azurerm-landing-zone-vending
- **Purpose**: Azure Landing Zone Subscription Vending wrapper module
- **Type**: Simple wrapper module
- **Submodules**: None
- **AVM Consumed**: `Azure/avm-ptn-alz-sub-vending/azure` version `0.1.0`
- **Latest Release**: v0.1.0 (pending merge - https://github.com/nathlan/terraform-azurerm-landing-zone-vending/pull/1)
- **Features**:
  - Simplified interface for subscription vending
  - Support for subscription alias creation and management group association
  - Resource group creation and role assignments
  - Virtual network deployment with hub peering and mesh connectivity
  - Automated release workflow for semantic versioning
  - Complete terraform-docs generated documentation

### terraform-azurerm-firewall
- **Purpose**: Azure Firewall module with opinionated defaults for Australian regions
- **Type**: Simple resource module
- **Submodules**: None
- **AVM Consumed**: `Azure/avm-res-network-azurefirewall/azurerm` version `~> 0.4.0`
- **Latest Release**: v0.1.0 (merged)
- **Latest PR**: v0.2.0 (pending - https://github.com/nathlan/terraform-azurerm-firewall/pull/2) - Adds missing files
- **Features**:
  - Support for both AZFW_VNet and AZFW_Hub SKU types
  - Location validation restricting to australiaeast or australiasoutheast
  - Support for Basic, Standard, and Premium SKU tiers
  - Integration with Azure Firewall Policy
  - Availability zones support
  - Resource locks and role assignments
  - Automated release workflow with initial version 0.1.0
  - Complete terraform-docs generated documentation
  - Configuration files (.checkov.yaml, .tflint.hcl, .terraform-docs.yml)
  - Examples directory with basic usage example

### terraform-azurerm-firewall-policy
- **Purpose**: Azure Firewall Policy module with comprehensive rule collection group support
- **Type**: Simple resource module
- **Submodules**: None (uses AVM submodule for rule collection groups)
- **AVM Consumed**: `Azure/avm-res-network-firewallpolicy/azurerm` version `~> 0.3` (currently 0.3.4)
- **AVM Submodule**: `Azure/avm-res-network-firewallpolicy/azurerm//modules/rule_collection_groups` version `~> 0.3`
- **Latest Release**: v0.1.0 (pending - https://github.com/nathlan/terraform-azurerm-firewall-policy/pull/1)
- **Status**: ðŸš§ PR created with core files, awaiting completion of file uploads
- **Features**:
  - Azure Firewall Policy creation with Standard, Premium, or Basic SKU
  - Rule collection groups (application rules, network rules, NAT rules)
  - DNS proxy configuration
  - Intrusion detection and prevention (IDPS) with signature overrides
  - Threat intelligence filtering with allowlist support
  - TLS inspection with Key Vault certificate integration
  - SQL redirect traffic filtering support
  - Explicit proxy configuration
  - Auto-learn private IP ranges
  - Resource locks and role assignments
  - Location validation restricting to australiaeast or australiasoutheast
  - Comprehensive input validation for all parameters
  - Automated release workflow with initial version 0.1.0
  - Complete terraform-docs generated documentation
  - Configuration files (.checkov.yaml, .tflint.hcl, .terraform-docs.yml)
  - Examples directory with basic usage example including application and network rules

## Notes

- All modules wrap Azure Verified Modules (AVM)
- Documentation is generated using `terraform-docs`
- Modules follow HashiCorp standard structure
- Submodules are used for resources with child types
- All modules include automated release workflows for semantic versioning
- Releases are created automatically on merge using conventional commits
- **Release workflow configuration**: Use `dexwritescode/release-on-merge-action@v1` with `initial-version: '0.1.0'` for initial releases (not 1.0.0)

## Lessons Learned

### Firewall Module Initial Creation (2026-02-05)
**Issue**: PR #1 was merged with incomplete files. The PR description stated "Additional files (will be pushed shortly)" but they were never added, resulting in:
- Missing `.checkov.yaml`, `.tflint.hcl`, `.terraform-docs.yml` configuration files
- Missing `examples/` directory
- Incomplete README without terraform-docs markers

**Resolution**: Created PR #2 to add all missing files and bring module into compliance with HashiCorp standard structure.

**Prevention**: 
- **NEVER** merge PRs with incomplete files or "will be pushed shortly" notes
- **ALWAYS** include ALL required files in the initial PR:
  - Configuration files: `.checkov.yaml`, `.tflint.hcl`, `.terraform-docs.yml`
  - Complete README with terraform-docs markers
  - At least one example in `examples/basic/` directory
  - All files must be present BEFORE marking PR as ready for review
- Use the PR creation workflow: Create as draft â†’ Push all files â†’ Validate â†’ Mark as ready
- The agent should validate the complete module structure before marking any PR as ready

### Agent Instructions Validation (2026-02-05)
**Issue**: Template file `.tflint.hcl.template` contained an invalid TFLint rule reference: `azurerm_resource_tag`. This rule does not exist in the azurerm ruleset and caused TFLint to fail with error "Rule not found: azurerm_resource_tag".

**Validation Results**: Tested against `terraform-azurerm-firewall` module:
- âœ… `terraform init -backend=false` - PASSED
- âœ… `terraform fmt -check -recursive` - PASSED
- âœ… `terraform validate` - PASSED
- âœ… `tflint --init` - PASSED (after template fix)
- âš ï¸ `tflint --recursive` - PASSED with 2 fixable warnings (empty list equality checks)
- âœ… `checkov --config-file .checkov.yaml` - PASSED (1 check passed, 0 failed)
- âœ… `terraform-docs` - PASSED (root and examples)

**Resolution**: Removed invalid `azurerm_resource_tag` rule from `.tflint.hcl.template`. The azurerm ruleset provides resource-specific validation rules (e.g., `azurerm_kubernetes_cluster_invalid_node_count`), not generic tag rules.

**Prevention**:
- Validate template files before using them in module creation
- Reference official documentation for TFLint azurerm rules: https://github.com/terraform-linters/tflint-ruleset-azurerm/tree/main/docs/rules
- Test the complete validation workflow against existing modules periodically

### Checkov Scanning Behavior Investigation (2026-02-05)
**Issue**: Checkov only reports 1 check when scanning modules that wrap Azure Verified Modules, when it should be detecting many more security checks.

**Root Cause**: Checkov excludes `.terraform/` directories by default (standard security practice to avoid scanning cached/downloaded code). The agent instructions specify running `terraform init -backend=false` before Checkov to download external modules for scanning, but this downloads modules to `.terraform/modules/` which Checkov then ignores!

**Evidence from terraform-azurerm-firewall**:
- Scanning root directory: `Passed checks: 1, Failed checks: 0, Skipped checks: 0` (only scans wrapper code)
- Scanning `.terraform/modules/avm_firewall/` directly: `Passed checks: 20, Failed checks: 1, Skipped checks: 0` (scans actual AVM module)
- The 1 failed check: `CKV_AZURE_216: "Ensure DenyIntelMode is set to Deny for Azure Firewalls"` - a real security finding!

**Current (Incorrect) Workflow**:
```bash
terraform init -backend=false  # Downloads AVM modules to .terraform/
checkov --config-file .checkov.yaml  # Ignores .terraform/ directory by default
# Result: Only scans local wrapper code, misses AVM module security checks
```

**Analysis of Options**:

1. **Scan .terraform/modules explicitly** (NOT RECOMMENDED)
   - Would require: `checkov -d . -d .terraform/modules/avm_*/`
   - Problems: Non-standard practice, may scan multiple copies, complicated paths
   
2. **Don't scan external modules** (CURRENT BEHAVIOR - ACCEPTABLE)
   - Wrapper modules are typically thin and pass-through most parameters to AVM
   - AVM modules are maintained by Microsoft and undergo their own security review
   - Security responsibility: Organizations should trust AVM OR fork and maintain their own
   - Module wrappers should focus on: input validation, sensible defaults, organizational policies
   
3. **Use terraform plan with Checkov** (ALTERNATIVE - MORE COMPREHENSIVE)
   - Generate plan: `terraform plan -out=tfplan.binary && terraform show -json tfplan.binary > tfplan.json`
   - Scan plan: `checkov -f tfplan.json --framework terraform_plan`
   - Scans the actual resources that would be created, including from external modules
   - More realistic security assessment of actual deployment
   - Requires valid provider credentials and terraform configuration

**Resolution**: The current behavior is ACCEPTABLE for wrapper modules. The instructions are working as intended:
- Wrapper modules (local code) are scanned for security issues
- External AVM modules are trusted upstream dependencies
- Running `terraform init -backend=false` is still useful for: TFLint (downloads providers), terraform validate
- Checkov scanning only wrapper code is appropriate for this use case

**Resolution (2026-02-05)**:

Use environment variable to enable scanning of downloaded modules:

```bash
terraform init -backend=false
CHECKOV_EXPERIMENTAL_TERRAFORM_MANAGED_MODULES=True checkov -d . --config-file .checkov.yml
```

**Configuration Updates**:
- Renamed `.checkov.yaml` to `.checkov.yml` for consistency
- Simplified `.checkov.yml` template (removed excessive comments)
- Simplified `.tflint.hcl` template (cleaner, focused on essentials)
